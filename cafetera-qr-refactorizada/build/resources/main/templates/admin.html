<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <title>Panel de Administrador</title>
    <!-- Tailwind CSS CDN para estilos modernos y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración para usar la fuente Inter -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

<div class="max-w-7xl mx-auto space-y-8">
    <!-- Encabezado y Saludo -->
    <header class="bg-white shadow-lg rounded-xl p-6 flex justify-between items-center">
        <h1 class="text-3xl font-extrabold text-indigo-700">Cafetera Admin Panel</h1>
        <a th:href="@{/logout}" class="text-sm font-medium text-red-600 hover:text-red-800 transition duration-150 ease-in-out">
            Cerrar Sesión
        </a>
    </header>

    <!-- Contenido Principal: Métricas y Datos -->
    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Columna 1 & 2: Gestión de Datos (Usuarios y Ventas) -->
        <div class="lg:col-span-2 space-y-6">

            <!-- 1. Gráfico de Ventas (Métricas) -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Rendimiento de Ventas</h2>
                <canvas id="ventasChart"></canvas>
            </div>

            <!-- 2. Lista de Usuarios (Datos y Gestión) -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Gestión de Usuarios</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acción</th>
                        </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="usuarios-table-body">
                        <!-- Datos cargados por JS -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

        <!-- Columna 3: Acciones Rápidas (Lateral) -->
        <div class="lg:col-span-1 space-y-6">

            <!-- Tarjeta de Saldo Global (Métrica Simple) -->
            <div class="bg-indigo-600 p-6 rounded-xl shadow-lg text-white">
                <p class="text-sm font-medium opacity-80">Saldo Total del Sistema</p>
                <p class="text-4xl font-bold mt-1" id="saldo-total">Cargando...</p>
                <p class="text-sm opacity-80 mt-2">Suma del saldo de todos los usuarios.</p>
            </div>

            <!-- Generador de Descripciones IA -->
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-pink-500">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Generador de Descripciones IA</h2>
                <p class="text-gray-500 text-sm mb-3">Genera textos de marketing para nuevos cafés usando Gemini.</p>

                <div class="space-y-3">
                    <input type="text" id="coffee-name" placeholder="Nombre del café (ej: Etiopía Sidamo)"
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-pink-500 focus:border-pink-500"/>
                    <input type="text" id="coffee-notes" placeholder="Notas de cata (ej: floral, cítrico, miel)"
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-pink-500 focus:border-pink-500"/>
                    <select id="coffee-style" class="w-full p-2 border border-gray-300 rounded-md focus:ring-pink-500 focus:border-pink-500">
                        <option value="corto">Descripción corta (Redes Sociales)</option>
                        <option value="medio">Descripción media (Web)</option>
                        <option value="largo">Descripción detallada (Etiqueta)</option>
                    </select>

                    <button onclick="generateDescription()" id="generate-button"
                            class="w-full bg-pink-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-pink-700 transition duration-150 ease-in-out shadow-md disabled:opacity-50">
                        Generar Descripción
                    </button>
                </div>

                <div id="ai-result-area" class="mt-4 p-4 bg-pink-50 rounded-lg border border-pink-200">
                    <p class="text-sm font-medium text-pink-700" id="ai-status">Esperando datos...</p>
                    <p class="text-gray-700 mt-2 text-sm whitespace-pre-wrap" id="ai-description"></p>
                </div>
            </div>

            <!-- Tarjeta de Acciones Rápidas -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Acciones</h2>
                <p class="text-gray-500 mb-4">Herramientas administrativas.</p>

                <button onclick="console.log('Generar QR de Prueba...')"
                        class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition duration-150 ease-in-out shadow-md mb-3">
                    Generar QR de Prueba
                </button>

                <button onclick="console.log('Ver Auditoría de Transacciones...')"
                        class="w-full bg-yellow-500 text-white py-2 px-4 rounded-lg font-medium hover:bg-yellow-600 transition duration-150 ease-in-out shadow-md">
                    Auditoría
                </button>
            </div>

        </div>

    </main>

</div>

<!-- Modal simple para recargar saldo (oculto por defecto) -->
<div id="recharge-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
        <h3 class="text-lg font-bold mb-4">Recargar Saldo</h3>
        <p id="modal-user-name" class="mb-3 text-sm text-gray-600"></p>
        <input type="number" id="recharge-amount" placeholder="Cantidad (€)"
               class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 mb-4"/>
        <div class="flex justify-end space-x-3">
            <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-gray-700 border rounded-md hover:bg-gray-100">Cancelar</button>
            <button onclick="handleRecharge()" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Confirmar</button>
        </div>
    </div>
</div>

<script>
    let currentUserId = null;

    // --- Funciones del Modal ---

    function openModal(userId, userName) {
        currentUserId = userId;
        document.getElementById('modal-user-name').textContent = `Recargando para: ${userName}`;
        document.getElementById('recharge-amount').value = '';
        document.getElementById('recharge-modal').classList.remove('hidden');
        document.getElementById('recharge-modal').classList.add('flex');
    }

    function closeModal() {
        document.getElementById('recharge-modal').classList.remove('flex');
        document.getElementById('recharge-modal').classList.add('hidden');
        currentUserId = null;
    }

    function handleRecharge() {
        const amount = parseFloat(document.getElementById('recharge-amount').value);
        if (currentUserId && amount > 0) {
            console.log(`Recargando ${amount}€ al usuario ID: ${currentUserId}`);

            // Llamada API POST real para recargar saldo
            fetch(`/api/admin/recargar/${currentUserId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: amount })
            })
            .then(response => {
                if (response.ok) {
                    console.log('Recarga exitosa. Recargando datos...');
                    loadUsers(); // Recargar los datos de usuarios
                } else {
                    console.error('Error en la recarga.');
                    alert('Error al recargar saldo. Verifique la consola para más detalles.');
                }
            })
            .catch(error => console.error('Error de red durante la recarga:', error));

            closeModal();
        } else {
            alert('Cantidad inválida o usuario no seleccionado.');
        }
    }

    // --- Generación de Descripción IA ---

    async function generateDescription() {
        const name = document.getElementById('coffee-name').value.trim();
        const notes = document.getElementById('coffee-notes').value.trim();
        const style = document.getElementById('coffee-style').value;
        const statusElement = document.getElementById('ai-status');
        const descriptionElement = document.getElementById('ai-description');
        const generateButton = document.getElementById('generate-button');

        if (!name || !notes) {
            statusElement.textContent = "Error: Nombre y notas de cata son obligatorios.";
            statusElement.classList.remove('text-pink-700');
            statusElement.classList.add('text-red-500');
            return;
        }

        // Habilitar estado de carga
        statusElement.textContent = "Generando descripción... (Puede tardar unos segundos)";
        statusElement.classList.remove('text-red-500');
        statusElement.classList.add('text-pink-700');
        descriptionElement.textContent = '';
        generateButton.disabled = true;

        const payload = {
            name: name,
            notes: notes,
            style: style
        };

        try {
            const response = await fetch('/api/admin/coffee/describe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }

            const data = await response.json();

            descriptionElement.textContent = data.description;
            statusElement.textContent = "Descripción generada con éxito.";
            statusElement.classList.remove('text-red-500');
            statusElement.classList.add('text-green-600');

        } catch (error) {
            console.error('Error al generar la descripción de IA:', error);
            statusElement.textContent = "Error al conectar con la IA. Verifique el backend y la consola.";
            descriptionElement.textContent = '';
            statusElement.classList.remove('text-pink-700', 'text-green-600');
            statusElement.classList.add('text-red-500');
        } finally {
            generateButton.disabled = false;
        }
    }


    // --- Carga de Datos ---

    function loadUsers() {
        const tableBody = document.getElementById('usuarios-table-body');
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Cargando usuarios...</td></tr>';

        fetch('/api/admin/usuarios')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error de red o autenticación: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                tableBody.innerHTML = ''; // Limpiar la tabla
                let totalSaldo = 0;

                data.forEach(usuario => {
                    // *** CAMBIO CLAVE: Convertir la cadena (String) de saldo a un número flotante (Float) ***
                    // Esto es necesario porque BigDecimal de Kotlin se serializa como String en JSON.
                    const saldoNumerico = parseFloat(usuario.saldo);

                    // Sumar al saldo total (Ahora es una suma numérica correcta)
                    totalSaldo += saldoNumerico;

                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${usuario.nombre}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${usuario.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-semibold">${saldoNumerico.toFixed(2)} €</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="openModal(${usuario.id}, '${usuario.nombre}')"
                                class="text-indigo-600 hover:text-indigo-900 transition duration-150 ease-in-out">
                                Recargar
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                // Actualizar el saldo total en la tarjeta lateral
                document.getElementById('saldo-total').textContent = `${totalSaldo.toFixed(2)} €`;
            })
            .catch(error => {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Error al cargar usuarios. Verifique la consola (F12).</td></tr>';
                console.error('Error cargando usuarios:', error);
            });
    }

    function loadVentasChart() {
        // Cargar datos de ventas
        fetch('/api/admin/ventas')
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('ventasChart').getContext('2d');

                // Asumiendo que 'data' es un objeto como: { labels: ['Ene', 'Feb', 'Mar'], values: [50, 60, 70] }
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Ventas (€)',
                            data: data.values,
                            backgroundColor: 'rgba(79, 70, 229, 0.7)', // Color índigo de Tailwind
                            borderColor: 'rgba(67, 56, 202, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            })
            .catch(error => console.error('Error cargando datos de ventas:', error));
    }

    // --- Ejecución al cargar la página ---
    window.onload = function() {
        loadUsers();
        loadVentasChart();
    };
</script>
</body>
</html>